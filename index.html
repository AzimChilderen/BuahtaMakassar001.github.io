<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>buahta.makassar </title>
    
    <link rel="icon" type="image/png" href="gambar/buahta.makassar.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --primary: #27ae60;
            --primary-light: #e8f5e9;
            --gradient: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            --accent: #f1c40f;
            --danger: #e74c3c;
            --glass: rgba(255, 255, 255, 0.95);
        }

        body { font-family: 'Poppins', sans-serif; background: #f8fafb; color: #2d3436; overflow-x: hidden; }
        h1, h2, h3, h4, h5, .navbar-brand { font-family: 'Fredoka', sans-serif; }

        .bg-blob { position: fixed; width: 400px; height: 400px; background: #d1f2eb; filter: blur(100px); border-radius: 50%; z-index: -1; opacity: 0.6; top: -100px; right: -100px; }

        /* Navbar Style */
        .navbar { background: var(--glass) !important; backdrop-filter: blur(15px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 15px 0; }
        .nav-logo { height: 45px; transition: 0.3s; }

        /* Admin Dashboard UI */
        .admin-card { background: white; border-radius: 20px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.04); padding: 25px; margin-bottom: 20px; }
        .stat-card { background: var(--gradient); color: white; border-radius: 20px; padding: 20px; display: flex; align-items: center; justify-content: space-between; }
        
        .form-control, .form-select { border-radius: 12px; padding: 12px; background: #f9f9f9; border: 1.5px solid #eee; transition: 0.3s; }
        .form-control:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        .btn-save { background: var(--gradient); color: white; border: none; border-radius: 12px; padding: 12px 25px; font-weight: 600; transition: 0.3s; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); color: white; }

        .product-item-row { transition: 0.3s; border-radius: 15px; }
        .product-item-row:hover { background: #f8fdfa; }
        .product-thumb { width: 55px; height: 55px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Fruit Card User */
        .fruit-card { background: white; border-radius: 25px; border: none; transition: 0.4s; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.02); height: 100%; }
        .fruit-card:hover { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0,0,0,0.08); }
        .fruit-img { height: 200px; object-fit: cover; width: 100%; }

        /* Login Overlay */
        #login-overlay { position: fixed; inset: 0; background: #f8fafb; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 100%; max-width: 380px; padding: 40px; border-radius: 30px; background: white; box-shadow: 0 20px 60px rgba(0,0,0,0.08); text-align: center; }

        #cart-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; padding: 12px 25px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1000; cursor: pointer; display: none; border: 2px solid var(--primary); min-width: 280px; }

        .preview-container { width: 100%; height: 180px; border-radius: 15px; overflow: hidden; background: #f1f1f1; border: 2px dashed #ccc; display: none; margin-bottom: 15px; }
        .preview-container img { width: 100%; height: 100%; object-fit: cover; }

        /* Checkout Item Control */
        .cart-control-btn { border: none; background: none; color: #27ae60; cursor: pointer; padding: 0 5px; }
        .cart-control-btn.text-danger { color: #e74c3c !important; }
    </style>
</head>
<body>

    <div class="bg-blob"></div>

    <div id="section-toko">
        <nav class="navbar navbar-expand-lg sticky-top">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="gambar/buahta.makassar.png" alt="Logo" class="nav-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/415/415733.png'">
                    <span class="fw-bold text-success ms-2 fs-4">buahta.makassar</span>
                </a>
                <div class="ms-auto d-flex align-items-center gap-3">
                    <button onclick="bukaPanelAdmin()" class="btn btn-sm btn-light border rounded-pill px-3 fw-bold text-success"><i class="bi bi-person-lock me-1"></i> Admin</button>
                    <a href="#katalog" class="btn btn-save d-none d-md-block px-4">Beli Sekarang</a>
                </div>
            </div>
        </nav>

        <section class="py-5">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 animate__animated animate__fadeInLeft">
                        
                        <div class="mb-4">
                            <img src="gambar/buahta.makassar.png" alt="Logo Buahta" 
                                 style="width: 120px; height: auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1));" 
                                 onerror="this.src='https://cdn-icons-png.flaticon.com/512/415/415733.png'">
                        </div>
        
                        <span class="badge px-3 py-2 rounded-pill mb-3" style="background: var(--primary-light); color: var(--primary);">
                             ✨ Premium Fruit Selection
                        </span>
                        
                        <h1 class="display-4 fw-bold mb-4">Segarkan Harimu dengan <span class="text-success">Buah Pilihan.</span></h1>
                        
                        <p class="lead text-muted mb-5">Kami menyediakan buah segar kualitas terbaik di Makassar, siap antar langsung ke depan pintu rumah Anda.</p>
                        
                        <div class="d-flex gap-3">
                            <a href="#katalog" class="btn btn-save btn-lg px-4">Lihat Menu</a>
                            <a href="#lokasi" class="btn btn-outline-success btn-lg rounded-pill px-4">Lokasi</a>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mt-5 mt-lg-0 animate__animated animate__zoomIn text-center">
                        <img src="gambar/toko.jpg" class="img-fluid rounded-5 shadow-lg" style="max-height: 400px; width:100%; object-fit:cover;">
                    </div>
                </div>
            </div>
        </section>

        <section id="katalog" class="container py-5">
            <h2 class="fw-bold mb-5 text-center">Katalog Buah Segar</h2>
            <div id="product-container-user" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4"></div>
        </section>

        <section id="lokasi" class="container py-5 border-top">
            <div class="row g-4 align-items-center">
                <div class="col-md-5">
                    <h3 class="fw-bold text-success mb-4"><i class="bi bi-geo-alt-fill me-2"></i>Kunjungi Kami</h3>
                    <div class="admin-card mb-4 border-start border-4 border-success">
                        <p class="mb-2"><strong>Alamat:</strong><br>BTP Blok L No.10, Tamalanrea, Makassar</p>
                        <hr>
                        <p class="mb-0"><strong>Pembayaran:</strong><br>BCA: 3900188764 - ABD ARAS HAS</p>
                    </div>
                    <a href="https://share.google/IQrDX6SPJFKj0n1Ov" target="_blank" class="btn btn-save w-100 py-3">Buka Google Maps</a>
                </div>
                <div class="col-md-7">
                    <div class="rounded-5 overflow-hidden shadow-sm border" style="height: 350px;">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3973.9315840615!2d119.49750000000001!3d-5.1147222!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2dbefd396924846b%3A0xc3f17d23d838b0f!2sBTP%20Blok%20L!5e0!3m2!1sid!2sid!4v1700000000000" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="section-admin" class="d-none">
        <div id="login-overlay" class="d-none">
            <div class="login-box animate__animated animate__zoomIn">
                <img src="gambar/buahta.makassar.png" style="width: 80px;" class="mb-3">
                <h4 class="fw-bold text-success">Admin Login</h4>
                <p class="text-muted small mb-4">Akses terbatas untuk pengelola toko.</p>
                <div class="mb-3">
                    <input type="password" id="admin-login-pass" class="form-control text-center py-3" placeholder="Masukkan Password">
                </div>
                <button class="btn-save w-100 mb-3" onclick="prosesLoginAdmin()">Masuk Dashboard</button>
                <button class="btn btn-link btn-sm text-decoration-none text-muted" onclick="kembaliKeToko()">Kembali ke Toko</button>
            </div>
        </div>

        <nav class="navbar navbar-light sticky-top shadow-sm">
            <div class="container">
                <div class="d-flex align-items-center">
                    <img src="gambar/buahta.makassar.png" height="35" class="me-2">
                    <span class="fw-bold text-success fs-5">Admin Buahta Makassar</span>
                </div>
                <div class="d-flex gap-2">
                    <button onclick="kembaliKeToko()" class="btn btn-light btn-sm rounded-pill px-3 border"><i class="bi bi-shop me-1"></i> Toko</button>
                    <button onclick="logoutAdmin()" class="btn btn-danger btn-sm rounded-pill px-3"><i class="bi bi-box-arrow-right"></i> Keluar</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="admin-card animate__animated animate__fadeInLeft">
                        <h5 class="fw-bold mb-4" id="form-title"><i class="bi bi-plus-circle-fill text-success me-2"></i>Tambah Produk</h5>
                        <form id="productForm">
                            <input type="hidden" id="editIndex" value="-1">
                            
                            <div class="mb-3">
                                <div id="boxPreview" class="preview-container"><img id="imgTampil" src=""></div>
                                <label class="btn btn-light w-100 border py-3 fw-bold" style="border-style: dashed !important; border-radius: 12px;">
                                    <i class="bi bi-image me-2 text-success"></i> Upload Foto
                                    <input type="file" id="p_file" accept="image/*" hidden onchange="handleFoto()">
                                </label>
                            </div>

                            <div class="mb-3">
                                <label class="small fw-bold mb-1">Nama Produk</label>
                                <input type="text" id="p_nama" class="form-control" placeholder="Contoh: Apel Fuji" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="small fw-bold mb-1">Keterangan Singkat</label>
                                <input type="text" id="p_sub" class="form-control" placeholder="Contoh: Manis & Garing" required>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="small fw-bold mb-1">Tipe Jual</label>
                                    <select id="p_tipe" class="form-select">
                                        <option value="berat">Per Kg</option>
                                        <option value="unit">Per Pcs</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="small fw-bold mb-1">Favorit?</label>
                                    <select id="p_fav" class="form-select">
                                        <option value="false">Tidak</option>
                                        <option value="true">Ya ⭐</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="small fw-bold mb-1">Varian & Harga (Varian:Harga)</label>
                                <textarea id="p_data" class="form-control" rows="3" placeholder="Contoh: Super:35000, Biasa:25000" required></textarea>
                                <small class="text-muted" style="font-size: 10px;">Pisahkan dengan koma untuk varian berbeda.</small>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn-save" id="btn-submit">Simpan Produk</button>
                                <button type="button" class="btn btn-light rounded-pill d-none" id="btn-cancel" onclick="resetForm()">Batal Edit</button>
                            </div>
                        </form>
                    </div>

                    <div class="admin-card animate__animated animate__fadeInLeft" style="animation-delay: 0.1s;">
                        <h6 class="fw-bold mb-3"><i class="bi bi-shield-lock-fill text-success me-2"></i>Keamanan Admin</h6>
                        <div id="password-list-container" class="mb-3"></div>
                        <div class="input-group">
                            <input type="text" id="new-password-input" class="form-control" placeholder="Password Baru">
                            <button class="btn btn-success" onclick="tambahPassword()"><i class="bi bi-plus"></i></button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="admin-card animate__animated animate__fadeInRight">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0">Daftar Katalog</h5>
                            <span class="badge bg-success rounded-pill px-3" id="count-text">0 Produk</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="border-radius: 12px 0 0 12px;">Produk</th>
                                        <th>Status</th>
                                        <th class="text-end" style="border-radius: 0 12px 12px 0;">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cart-bar" class="animate__animated animate__fadeInUp" onclick="openCheckout()">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="bg-success text-white rounded-circle p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-cart-fill"></i>
                </div>
                <div>
                    <div class="small text-muted fw-bold" id="cart-count">0 Item</div>
                    <div class="fw-bold text-success" id="cart-total-display">Rp 0</div>
                </div>
            </div>
            <i class="bi bi-arrow-right-circle-fill fs-3 text-success"></i>
        </div>
    </div>

    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-5">
                <div class="modal-body p-4">
                    <h4 class="fw-bold text-success text-center mb-4" id="m_name">Produk</h4>
                    <div class="mb-3">
                        <label class="small fw-bold mb-1">Pilih Varian</label>
                        <select id="m_variant" class="form-select" onchange="calculateLivePrice()"></select>
                    </div>
                    <div id="m_weight_box" class="mb-3">
                        <label class="small fw-bold mb-1">Pilih Berat</label>
                        <select id="m_weight" class="form-select" onchange="calculateLivePrice()">
                            <option value="0.5">500 Gram</option>
                            <option value="1" selected>1 Kilogram</option>
                            <option value="2">2 Kilogram</option>
                        </select>
                    </div>
                    <div id="m_qty_box" class="mb-3 d-none">
                        <label class="small fw-bold mb-1">Jumlah Pesanan</label>
                        <input type="number" id="m_qty" class="form-control" value="1" min="1" oninput="calculateLivePrice()">
                    </div>
                    <div class="p-3 text-center mb-4" style="background:var(--primary-light); border-radius:20px;">
                        <span class="small text-muted d-block">Harga Estimasi</span>
                        <h3 class="fw-bold text-success mb-0" id="live-price-text">Rp 0</h3>
                    </div>
                    <button class="btn btn-save w-100 py-3" onclick="addToCart()">Tambahkan ke Keranjang</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-5">
                <div class="modal-body p-4">
                    <h4 class="fw-bold text-success mb-4"><i class="bi bi-bag-check-fill me-2"></i>Konfirmasi Pesanan</h4>
                    <div id="checkout-list" class="mb-4 bg-light p-3 rounded-4 border small"></div>
                    <div class="mb-3">
                        <input type="text" id="c_name" class="form-control" placeholder="Nama Lengkap Penerima" required>
                    </div>
                    <div class="mb-4">
                        <textarea id="c_note" class="form-control" placeholder="Alamat Lengkap / Catatan"></textarea>
                    </div>
                    <div class="text-center mb-4">
                        <span class="text-muted small">Total yang harus dibayar:</span>
                        <h3 class="fw-bold text-success" id="final-total">Rp 0</h3>
                    </div>
                    <button class="btn btn-save w-100 py-3" onclick="sendToWA()">Kirim ke WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // DATA UTAMA
        let daftarBuah = JSON.parse(localStorage.getItem('produk_buah')) || [];
        let listPasswordAdmin = JSON.parse(localStorage.getItem('admin_passwords')) || ['admin123'];
        let keranjang = [];
        let base64Foto = "";
        let currentProduct = null;

        // SISTEM KEAMANAN & SESSION
        window.onload = function() {
            const lastPage = sessionStorage.getItem('current_page');
            if (lastPage === 'admin') {
                bukaPanelAdmin();
            } else {
                renderUserKatalog();
            }
        };

        function bukaPanelAdmin() {
            const isLoggedIn = localStorage.getItem('is_admin_logged');
            document.getElementById('section-toko').classList.add('d-none');
            document.getElementById('section-admin').classList.remove('d-none');
            sessionStorage.setItem('current_page', 'admin');

            if (isLoggedIn === 'true') {
                document.getElementById('login-overlay').classList.add('d-none');
                renderAdminTable();
                renderPasswordList();
            } else {
                document.getElementById('login-overlay').classList.remove('d-none');
            }
        }

        function kembaliKeToko() {
            document.getElementById('section-admin').classList.add('d-none');
            document.getElementById('section-toko').classList.remove('d-none');
            sessionStorage.setItem('current_page', 'toko');
            renderUserKatalog();
        }

        function prosesLoginAdmin() {
            const passInput = document.getElementById('admin-login-pass').value;
            if (listPasswordAdmin.includes(passInput)) {
                localStorage.setItem('is_admin_logged', 'true');
                document.getElementById('login-overlay').classList.add('animate__animated', 'animate__fadeOut');
                setTimeout(() => {
                    document.getElementById('login-overlay').classList.add('d-none');
                    document.getElementById('login-overlay').classList.remove('animate__fadeOut');
                    renderAdminTable();
                    renderPasswordList();
                }, 500);
            } else {
                alert("Password Salah!");
            }
        }

        function logoutAdmin() {
            if(confirm("Apakah Anda yakin ingin logout?")) {
                localStorage.removeItem('is_admin_logged');
                document.getElementById('admin-login-pass').value = "";
                document.getElementById('login-overlay').classList.remove('d-none');
                document.getElementById('login-overlay').classList.add('animate__fadeIn');
            }
        }

        // MANAJEMEN PASSWORD
        function renderPasswordList() {
            const container = document.getElementById('password-list-container');
            container.innerHTML = listPasswordAdmin.map((p, i) => `
                <div class="d-flex justify-content-between align-items-center bg-light p-2 px-3 rounded-pill mb-2 border">
                    <span class="small font-monospace">${p}</span>
                    ${listPasswordAdmin.length > 1 ? `<i class="bi bi-trash text-danger cursor-pointer" onclick="hapusPassword(${i})"></i>` : ''}
                </div>
            `).join('');
        }

        function tambahPassword() {
            const input = document.getElementById('new-password-input');
            const p = input.value.trim();
            if (p.length < 3) return alert("Min 3 karakter");
            listPasswordAdmin.push(p);
            localStorage.setItem('admin_passwords', JSON.stringify(listPasswordAdmin));
            input.value = "";
            renderPasswordList();
        }

        function hapusPassword(i) {
            if(confirm("Hapus password?")) {
                listPasswordAdmin.splice(i, 1);
                localStorage.setItem('admin_passwords', JSON.stringify(listPasswordAdmin));
                renderPasswordList();
            }
        }

        // MANAJEMEN PRODUK
        function handleFoto() {
            const file = document.getElementById('p_file').files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                base64Foto = reader.result;
                document.getElementById('imgTampil').src = reader.result;
                document.getElementById('boxPreview').style.display = 'block';
            }
            if(file) reader.readAsDataURL(file);
        }

        document.getElementById('productForm').onsubmit = function(e) {
            e.preventDefault();
            const index = parseInt(document.getElementById('editIndex').value);
            const raw = document.getElementById('p_data').value.split(',');
            let vars = [], hrg = [];
            
            raw.forEach(item => {
                const p = item.split(':');
                if(p.length === 2) {
                    vars.push(p[0].trim());
                    hrg.push(parseInt(p[1].trim()));
                }
            });

            const data = {
                nama: document.getElementById('p_nama').value,
                sub: document.getElementById('p_sub').value,
                foto: base64Foto || (index >= 0 ? daftarBuah[index].foto : 'https://placehold.co/400x300?text=Buah'),
                tipe: document.getElementById('p_tipe').value,
                fav: document.getElementById('p_fav').value === 'true',
                varian: vars,
                harga: hrg
            };

            if(index === -1) daftarBuah.push(data);
            else daftarBuah[index] = data;

            localStorage.setItem('produk_buah', JSON.stringify(daftarBuah));
            renderAdminTable();
            resetForm();
            alert("Berhasil disimpan!");
        }

        function renderAdminTable() {
            const tbody = document.getElementById('admin-table-body');
            document.getElementById('count-text').innerText = `${daftarBuah.length} Produk`;
            
            tbody.innerHTML = daftarBuah.map((b, i) => `
                <tr class="product-item-row">
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${b.foto}" class="product-thumb me-3 border">
                            <div>
                                <div class="fw-bold mb-0">${b.nama}</div>
                                <div class="text-muted" style="font-size: 11px;">${b.sub}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${b.fav ? 'bg-warning text-dark' : 'bg-light text-muted border'} px-2" style="font-size: 10px;">
                            ${b.fav ? 'FAVORIT ⭐' : 'NORMAL'}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary border-0" onclick="editData(${i})"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="hapusData(${i})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editData(i) {
            const b = daftarBuah[i];
            document.getElementById('editIndex').value = i;
            document.getElementById('p_nama').value = b.nama;
            document.getElementById('p_sub').value = b.sub;
            document.getElementById('p_tipe').value = b.tipe;
            document.getElementById('p_fav').value = b.fav.toString();
            document.getElementById('p_data').value = b.varian.map((v, idx) => `${v}:${b.harga[idx]}`).join(', ');
            
            document.getElementById('imgTampil').src = b.foto;
            document.getElementById('boxPreview').style.display = 'block';
            base64Foto = b.foto;

            document.getElementById('form-title').innerText = "Edit Produk";
            document.getElementById('btn-submit').innerText = "Update Produk";
            document.getElementById('btn-cancel').classList.remove('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hapusData(i) {
            if(confirm('Hapus ' + daftarBuah[i].nama + '?')) {
                daftarBuah.splice(i, 1);
                localStorage.setItem('produk_buah', JSON.stringify(daftarBuah));
                renderAdminTable();
            }
        }

        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('editIndex').value = "-1";
            document.getElementById('boxPreview').style.display = 'none';
            document.getElementById('form-title').innerText = "Tambah Produk";
            document.getElementById('btn-submit').innerText = "Simpan Produk";
            document.getElementById('btn-cancel').classList.add('d-none');
            base64Foto = "";
        }

        // SISTEM TOKO (USER)
        function renderUserKatalog() {
            const container = document.getElementById('product-container-user');
            if (daftarBuah.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-5 text-muted">Belum ada stok buah.</div>';
                return;
            }

            container.innerHTML = daftarBuah.map((b, i) => `
                <div class="col animate__animated animate__fadeInUp">
                    <div class="fruit-card">
                        <img src="${b.foto}" class="fruit-img" loading="lazy">
                        <div class="p-3">
                            <h6 class="fw-bold mb-1">${b.nama} ${b.fav ? '⭐' : ''}</h6>
                            <p class="small text-muted mb-3" style="font-size: 11px;">${b.sub}</p>
                            <button onclick="bukaModalBeli(${i})" class="btn btn-save btn-sm w-100 py-2">Pesan Sekarang</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function bukaModalBeli(i) {
            currentProduct = daftarBuah[i];
            document.getElementById('m_name').innerText = currentProduct.nama;
            
            let vHtml = "";
            currentProduct.varian.forEach((v, idx) => {
                vHtml += `<option value="${idx}">${v} - Rp ${currentProduct.harga[idx].toLocaleString()}</option>`;
            });
            document.getElementById('m_variant').innerHTML = vHtml;

            if (currentProduct.tipe === 'unit') {
                document.getElementById('m_weight_box').classList.add('d-none');
                document.getElementById('m_qty_box').classList.remove('d-none');
            } else {
                document.getElementById('m_weight_box').classList.remove('d-none');
                document.getElementById('m_qty_box').classList.add('d-none');
            }

            calculateLivePrice();
            new bootstrap.Modal('#orderModal').show();
        }

        function calculateLivePrice() {
            const vIdx = document.getElementById('m_variant').value;
            const hrgBase = currentProduct.harga[vIdx];
            let total = 0;

            if (currentProduct.tipe === 'unit') {
                total = hrgBase * document.getElementById('m_qty').value;
            } else {
                total = hrgBase * document.getElementById('m_weight').value;
            }
            document.getElementById('live-price-text').innerText = "Rp " + total.toLocaleString();
        }

        function addToCart() {
            const vIdx = document.getElementById('m_variant').value;
            const hrgBase = currentProduct.harga[vIdx];
            const varianNama = currentProduct.varian[vIdx];
            let qtyVal, qtyStr, subtotal;

            if (currentProduct.tipe === 'unit') {
                qtyVal = parseFloat(document.getElementById('m_qty').value);
                qtyStr = qtyVal + " Pcs";
            } else {
                qtyVal = parseFloat(document.getElementById('m_weight').value);
                qtyStr = (qtyVal * 1000) + " Gram";
            }
            
            subtotal = hrgBase * qtyVal;

            // Cari apakah item yang sama sudah ada
            const existIdx = keranjang.findIndex(k => k.nama === currentProduct.nama && k.varian === varianNama && k.tipe === currentProduct.tipe);
            
            if(existIdx >= 0) {
                keranjang[existIdx].qtyVal += qtyVal;
                keranjang[existIdx].qty = (currentProduct.tipe === 'unit') ? (keranjang[existIdx].qtyVal + " Pcs") : (keranjang[existIdx].qtyVal * 1000 + " Gram");
                keranjang[existIdx].total = hrgBase * keranjang[existIdx].qtyVal;
            } else {
                keranjang.push({
                    nama: currentProduct.nama,
                    varian: varianNama,
                    qty: qtyStr,
                    qtyVal: qtyVal,
                    hrgBase: hrgBase,
                    tipe: currentProduct.tipe,
                    total: subtotal
                });
            }

            updateCart();
            bootstrap.Modal.getInstance('#orderModal').hide();
        }

        function updateCart() {
            const count = keranjang.length;
            if(count > 0) {
                document.getElementById('cart-bar').style.display = 'block';
                document.getElementById('cart-count').innerText = count + " Item";
                const total = keranjang.reduce((sum, item) => sum + item.total, 0);
                document.getElementById('cart-total-display').innerText = "Rp " + total.toLocaleString();
            } else {
                document.getElementById('cart-bar').style.display = 'none';
            }
        }

        function changeQty(idx, delta) {
            const item = keranjang[idx];
            const step = item.tipe === 'unit' ? 1 : 0.5;
            item.qtyVal += (delta * step);
            
            if(item.qtyVal <= 0) {
                hapusItem(idx);
            } else {
                item.qty = (item.tipe === 'unit') ? (item.qtyVal + " Pcs") : (item.qtyVal * 1000 + " Gram");
                item.total = item.hrgBase * item.qtyVal;
                renderCheckoutList();
            }
            updateCart();
        }

        function hapusItem(idx) {
            keranjang.splice(idx, 1);
            if(keranjang.length === 0) {
                bootstrap.Modal.getInstance('#checkoutModal').hide();
            }
            renderCheckoutList();
            updateCart();
        }

        function renderCheckoutList() {
            let html = "";
            let total = 0;
            keranjang.forEach((item, idx) => {
                html += `
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <div style="flex-grow:1">
                        <div class="fw-bold text-dark">${item.nama} <small class="text-muted fw-normal">(${item.varian})</small></div>
                        <div class="d-flex align-items-center gap-2 mt-1">
                            <button class="cart-control-btn" onclick="changeQty(${idx}, -1)"><i class="bi bi-dash-circle"></i></button>
                            <span class="badge bg-white border text-dark">${item.qty}</span>
                            <button class="cart-control-btn" onclick="changeQty(${idx}, 1)"><i class="bi bi-plus-circle"></i></button>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">Rp ${item.total.toLocaleString()}</div>
                        <button class="cart-control-btn text-danger small" onclick="hapusItem(${idx})"><i class="bi bi-trash"></i></button>
                    </div>
                </div>`;
                total += item.total;
            });
            document.getElementById('checkout-list').innerHTML = html || '<p class="text-center py-3">Keranjang kosong</p>';
            document.getElementById('final-total').innerText = "Rp " + total.toLocaleString();
        }

        function openCheckout() {
            renderCheckoutList();
            new bootstrap.Modal('#checkoutModal').show();
        }

        function sendToWA() {
            const nama = document.getElementById('c_name').value;
            const note = document.getElementById('c_note').value;
            if(!nama) return alert("Nama wajib diisi");

            let pesan = `*PESANAN BARU - BUAHTA.MAKASSAR*\n\n`;
            pesan += `Nama: ${nama}\n`;
            pesan += `Catatan: ${note || '-'}\n\n`;
            pesan += `*Daftar Buah:*\n`;
            
            keranjang.forEach(item => {
                pesan += `- ${item.nama} (${item.varian}) [${item.qty}] : Rp ${item.total.toLocaleString()}\n`;
            });

            const total = keranjang.reduce((sum, item) => sum + item.total, 0);
            pesan += `\n*TOTAL PEMBAYARAN: Rp ${total.toLocaleString()}*`;
            pesan += `\n\n_Mohon tunggu konfirmasi admin untuk total ongkir._`;
            
            const url = `https://wa.me/6282398124858?text=${encodeURIComponent(pesan)}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>